<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0, minimum-scale=1.0" />
    <title>ระบบขอสั่งอะไหล่คลังสินค้านวนคร</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1877f2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ระบบขอสั่งอะไหล่คลังสินค้านวนคร">
    <link rel="apple-touch-icon" href="/icon-192.png">

    <!-- Security Headers (CSP แก้แล้ว ไม่บล็อก SweetAlert2 อีกต่อไป) -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' https:;
      script-src 'self' 'unsafe-inline' 
                 https://cdn.jsdelivr.net 
                 https://unpkg.com 
                 https://code.jquery.com 
                 https://opensheet.elk.sh 
                 https://docs.google.com 
                 https://script.google.com 
                 https://script.googleusercontent.com;
      style-src 'self' 'unsafe-inline' 
                https://fonts.googleapis.com 
                https://cdnjs.cloudflare.com 
                https://cdn.jsdelivr.net;
      font-src https://fonts.gstatic.com https://cdnjs.cloudflare.com;
      img-src 'self' data: https: blob: 
              https://drive.google.com 
              https://lh3.googleusercontent.com;
      connect-src 'self' 
                  https://opensheet.elk.sh 
                  https://docs.google.com 
                  https://script.google.com 
                  https://script.googleusercontent.com 
                  https://cdn.jsdelivr.net;
      frame-src https://docs.google.com https://drive.google.com;
      object-src 'none'; 
      base-uri 'self'; 
      form-action 'self' https://docs.google.com;
    ">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="description" content="ระบบภายในสำหรับขอสั่งอะไหล่คลังสินค้านวนคร - เครื่องมือสำหรับพนักงานเท่านั้น">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

    <!-- Your Custom CSS -->
    <link rel="stylesheet" href="style.css">
  </head>

  <body class="light-mode">
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal active">
      <div class="login-content">
        <h2>เข้าสู่ระบบ</h2>
        <input type="text" id="username" placeholder="รหัสพนักงาน" />
        <div class="password-container">
          <input type="password" id="password" placeholder="รหัสผ่าน (ให้นึกก่อน)" />
          <i class="fas fa-eye-slash" id="togglePassword"></i>
        </div>
        <div class="remember-me">
          <input type="checkbox" id="rememberMe" />
          <label for="rememberMe">Remember me</label>
        </div>
        <button onclick="handleLogin()">เข้าสู่ระบบ</button>
        <div id="loginError" class="error">ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง!</div>
      </div>
    </div>

    <!-- App Content -->
    <div id="appContent" class="app-content">
      <!-- Header -->
      <div class="header">
        <div class="header-title">
          <span>ระบบขอสั่งอะไหล่จากคลังนวนคร</span>
        </div>
        <button id="install-btn" title="ติดตั้ง PartsGo บนหน้าจอหลัก" style="display:none !important;">
          <i class="fas fa-download"></i> ติดตั้ง
        </button>
        <button class="header-notification-btn" onclick="openAnnouncementDeck()" title="ประกาศจากคลัง">
          <i class="fas fa-bell"></i>
          <span id="notificationBadge" class="notification-badge" style="display:none;">!</span>
        </button>
        <span id="userNameSmall" class="user-name-small"></span>
        <button class="header-setting-btn" onclick="showSettings()" title="ตั้งค่า"><i class="fas fa-bars"></i></button>
      </div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>กำลังโหลดข้อมูล...</span>
      </div>

      <div class="container">
        <!-- Tabs (ซ่อนไว้) -->
        <div class="tabs" style="display: none;">
          <button class="tab-button active" id="tab-parts" onclick="showTab('parts')">ค้นหาอะไหล่เพื่อเบิก</button>
          <button class="tab-button" id="tab-images" onclick="showTab('images')">ค้นหารูป</button>
          <button class="tab-button" id="tab-today" onclick="showTab('today')">รายการเบิกประจำวันนี้</button>
          <button class="tab-button" id="tab-pending-calls" onclick="showTab('pending-calls')">อะไหล่จ่ายตาม Call</button>
        </div>

        <!-- Parts Tab -->
        <div id="parts" class="tab-content active">
          <div id="searchContainer">
            <input type="text" id="searchInput1" placeholder="ค้นหา ตัวกรองหลัก" />
            <input type="text" id="searchInput2" placeholder="ค้นหา ตัวกรองย่อย" />
            <button id="searchButton" class="canva-button">
              <i class="fas fa-redo"></i> <span>Clear</span>
            </button>
          </div>
          <div id="error-container">
            <p id="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button">ลองใหม่</button>
          </div>
          <div class="table-container">
            <table id="data-table">
              <thead>
                <tr>
                  <th>เบิก</th>
                  <th>รูป</th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>วิภาวดี</th>
                  <th>นวนคร</th>
                  <th>Rebuilt</th>
                  <th>หมายเหตุ</th>
                  <th>Product</th>
                  <th>Spec</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        <!-- Images Tab -->
        <div id="images" class="tab-content">
          <div id="searchContainerImages">
            <input type="text" id="searchInputImages1" placeholder="ค้นหา ตัวกรองหลัก" />
            <input type="text" id="searchInputImages2" placeholder="ค้นหา ตัวกรองย่อย" />
            <button id="searchButtonImages" class="canva-button">
              <i class="fas fa-redo"></i> <span>Clear</span>
            </button>
          </div>
          <div id="error-container-images">
            <p id="error-message-images">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button-images">ลองใหม่</button>
          </div>
          <div class="gallery-container-images" id="gallery-container-images"></div>
          <div id="imageModalImages" class="image-modal-images">
            <div class="image-modal-content-images">
              <span class="image-close-images" id="closeImageModalImages">×</span>
              <div id="imageModalContentImages"></div>
            </div>
          </div>
          <div id="paginationImages" class="pagination-images">
            <button id="firstPageImages"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPageImages"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersImages"></div>
            <button id="nextPageImages"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageImages"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></button>
            <div class="items-per-page-images">
              <label for="itemsPerPageImages">Show</label>
              <select id="itemsPerPageImages">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Today Tab -->
        <div id="today" class="tab-content">
          <div class="today-warning">ระบบจะตัดรอบการเบิกในเวลา 14.50น.</div>
          <div id="searchContainer">
            <input type="text" id="searchInputToday" placeholder="ค้นหา Code, Material, ชื่อช่าง หรือ ทีม..." />
            <button id="toggleAllDataBtn" class=" cuáles-button" title="กำลังแสดงเฉพาะรายการที่รอเบิก">
              <i class="fas fa-clock"></i> <span>รอเบิก</span>
            </button>
          </div>
          <div id="error-container-today" class="error-container" style="display: none;">
            <p id="error-message-today">เกิดข้อผิดพลาดในการโหลดข้อมูล กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่</p>
            <button id="retry-button-today">ลองใหม่</button>
          </div>
          <div id="loadingToday" class="spinner-container">
            <div class="spinner"></div>
            <p>กำลังโหลดข้อมูล...</p>
          </div>
          <div class="table-container">
            <table id="data-table-today">
              <thead>
                <tr>
                  <th>Status</th>
                  <th class="sortable" data-column="IDRow">ลำดับ <span class="today-arrow">Down Arrow</span></th>
                  <th class="sortable" data-column="Timestamp">วันเวลา <span class="today-arrow">Down Arrow</span></th>
                  <th>Material</th>
                  <th>Description</th>
                  <th>จำนวน</th>
                  <th>วิภาวดี</th>
                  <th>ชื่อช่าง</th>
                  <th>หน่วยงาน</th>
                  <th>Call</th>
                  <th>CallType</th>
                  <th>หมายเหตุ</th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="paginationToday" class="pagination-today">
            <button id="firstPageToday"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPageToday"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersToday"></div>
            <button id="nextPageToday"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageToday"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></button>
            <div class="items-per-page-today">
              <label for="itemsPerPageToday">Show</label>
              <select id="itemsPerPageToday">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="30">30</option>
              </select>
            </div>
          </div>
          <div id="detailModal" class="modal">
            <div class="modal-content">
              <span class="close" id="closeModal">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContent"></div>
            </div>
          </div>
        </div>

        <!-- Pending Calls Tab -->
        <div id="pending-calls" class="tab-content">
          <div id="searchContainerPending">
            <div class="pending-filter-row">
              <label id="teamFilterLabelPending" for="teamFilterPending" class="pending-modern-label">เลือกทีม</label>
              <select id="teamFilterPending"><option value="">ทั้งหมด</option></select>
              <div id="callCountInfoPending" class="pending-call-count-box">
                จำนวน Ticket ค้าง <span id="callCountValuePending">0</span> Call
              </div>
            </div>
            <div class="pending-search-row">
              <input type="text" id="searchInputPending" placeholder="ค้นหา Ticket, Team, สาขา, ค้างหน่วยงาน, Material, Description..." />
              <button id="searchButtonPending"><i class="fas fa-search"></i></button>
            </div>
          </div>
          <div class="pending-table-container">
            <table id="data-table-pending">
              <thead>
                <tr>
                  <th class="sortable" data-column="DateTime">วันที่แจ้ง <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Ticket Number">Ticket <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Team">Team <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Brand">สาขา <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="ค้างหน่วยงาน">ค้างหน่วยงาน <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Material">Material <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Description">Description <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="Vipa">คงเหลือ <span class="pending-arrow"></span></th>
                  <th class="sortable" data-column="DayRepair">ค้าง(วัน) <span class="pending-arrow"></span></th>
                  <th>ดูรายละเอียด</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="detailModalPending" class="pending-modal">
            <div class="pending-modal-content">
              <span class="pending-close" id="closeModalPending">×</span>
              <h2>รายละเอียด</h2>
              <div id="modalContentPending"></div>
            </div>
          </div>
          <div class="pending-pagination">
            <button id="firstPagePending"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i></button>
            <button id="prevPagePending"><i class="fas fa-chevron-left"></i></button>
            <div id="pageNumbersPending"></div>
            <button id="nextPagePending"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPagePending"><i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></button>
            <div class="pending-items-per-page">
              <label for="itemsPerPagePending">รายการต่อหน้า:</label>
              <select id="itemsPerPagePending">
                <option value="10">10 รายการ</option>
                <option value="20" selected>20 รายการ</option>
                <option value="30">30 รายการ</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Modal -->
      <div id="settingsModal" class="settings-modal">
        <div class="settings-modal-content">
          <span class="close-settings" id="closeSettings">×</span>
          <h2>การตั้งค่า</h2>
          <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 16px; padding: 16px; margin: 16px 0; box-shadow: 0 4px 15px rgba(24,118,242,0.15);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 60px; height: 60px; background: #1877f2; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <div style="font-weight: bold; font-size: 16px; color: #0d47a1;" id="modalUserName">ชื่อผู้ใช้</div>
                <div style="font-size: 13px; color: #555;">รหัสพนักงาน: <span id="modalUserID">-</span></div>
              </div>
            </div>
            <div style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 12px; font-size: 14px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-building" style="color: #1976d2;"></i>
                <strong>หน่วยงาน:</strong> <span id="modalUserTeam" style="color: #1976d2; font-weight: 500;">กำลังโหลด...</span>
              </div>
            </div>
          </div>

          <div id="adminAnnouncementSection" style="display: none; margin: 20px 0;">
            <button onclick="openAnnouncementEditor()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; border: none; border-radius: 16px; font-size: 15px; font-weight: bold; box-shadow: 0 4px 15px rgba(231,76,60,0.4);">
              <i class="fas fa-bullhorn"></i> ตั้งค่าประกาศถึงพนักงาน
            </button>
          </div>

          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">
              <i class="fas fa-palette"></i> โหมดธีม
            </label>
            <select id="themeSelect" style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; font-size: 15px; background: white;">
              <option value="light">โหมดสว่าง (Light)</option>
              <option value="dark">โหมดมืด (Dark)</option>
            </select>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="modal-qr-btn" onclick="showQRCode()" style="flex: 1; padding: 14px; font-size: 15px; border-radius: 16px;">
              <i class="fas fa-qrcode"></i> QR Code
            </button>
            <button class="modal-logout-btn" onclick="handleLogout()" style="flex: 1; padding: 14px; font-size: 15px; border-radius: 16px;">
              <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
            </button>
          </div>

          <div style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #0d47a1, #1565c0); color: white; border-radius: 16px; text-align: center; font-size: 11px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <p style="margin: 6px 0; font-weight: bold; font-size: 13px;">PartsGo เวอร์ชัน <span id="appVersion">v10</span></p>
            <p style="margin: 4px 0; opacity: 0.9;">© 2025 คลังสินค้า SparePart วิภาวดี 62</p>
            <p style="margin: 4px 0; opacity: 0.8; font-size: 10px;">สงวนลิขสิทธิ์ • ระบบภายในสำหรับพนักงานเท่านั้น</p>
          </div>
        </div>
      </div>

      <!-- Bottom Navigation -->
      <div class="bottom-nav">
        <button class="nav-btn active" id="nav-parts" data-tab="parts" onclick="showTab('parts')" data-label="ค้นหาอะไหล่"><i class="fas fa-search"></i></button>
        <button class="nav-btn" id="nav-images" data-tab="images" onclick="showTab('images')" data-label="รูปภาพ"><i class="fas fa-images"></i></button>
        <button class="nav-btn" id="nav-today" data-tab="today" onclick="showTab('today')" data-label="เบิกวันนี้"><i class="fas fa-calendar-day"></i></button>
        <button class="nav-btn" id="nav-pending" data-tab="pending-calls" onclick="showTab('pending-calls')" data-label="Call"><i class="fas fa-phone"></i></button>
      </div>
    </div>

    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="script.js" defer></script>
  </body>
</html>
